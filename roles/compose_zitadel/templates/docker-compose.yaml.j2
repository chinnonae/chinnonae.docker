{{ ansible_managed | comment }}
---
services:
  zitadel:
    image: "{{ compose_zitadel_image_url }}:{{ compose_zitadel_image_tag }}"
    command: start-from-init --masterkeyFromEnv
    environment:
      # https://zitadel.com/docs/self-hosting/manage/configure#runtime-configuration-file
      ZITADEL_MASTERKEY: "{{ compose_zitadel_masterkey }}"
      # WEB CONFIG
      ZITADEL_EXTERNALPORT: "443"
      ZITADEL_EXTERNALSECURE: true
      ZITADEL_TLS_ENABLED: false
      ZITADEL_EXTERNALDOMAIN: "{{ compose_zitadel_host }}"
      # DB CONFIG
      ZITADEL_DATABASE_POSTGRES_HOST: "{{ compose_zitadel_db_host }}"
      ZITADEL_DATABASE_POSTGRES_PORT: "{{ compose_zitadel_db_port }}"
      ZITADEL_DATABASE_POSTGRES_DATABASE: "{{ compose_zitadel_db_dbname }}"
      ZITADEL_DATABASE_POSTGRES_USER_USERNAME: "{{ compose_zitadel_db_username }}"
      ZITADEL_DATABASE_POSTGRES_USER_PASSWORD: "{{ compose_zitadel_db_password }}"
      ZITADEL_DATABASE_POSTGRES_USER_SSL_MODE: "{{ compose_zitadel_db_ssl }}"
      ZITADEL_DATABASE_POSTGRES_ADMIN_USERNAME: "{{ compose_zitadel_db_username }}"
      ZITADEL_DATABASE_POSTGRES_ADMIN_PASSWORD: "{{ compose_zitadel_db_password }}"
      ZITADEL_DATABASE_POSTGRES_ADMIN_SSL_MODE: "{{ compose_zitadel_db_ssl }}"
      # FIRST INSTANCE
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_USERNAME: zitadel-admin
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_EMAIL_ADDRESS: zitadel-admin@localhost
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORD: Password1!
      ZITADEL_FIRSTINSTANCE_ORG_HUMAN_PASSWORDCHANGEREQUIRED: false
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - default
      - traefik
    labels:
      traefik.enable: "true"
      traefik.http.routers.zitadel.rule: "Host(`{{ compose_zitadel_host }}`)"
      traefik.http.routers.zitadel.entrypoints: "https"
      traefik.http.routers.zitadel.tls: "true"
      traefik.http.routers.zitadel.tls.certresolver: "http01"
      traefik.http.services.zitadel.loadbalancer.server.port: "8080"
      traefik.docker.network: "traefik"

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: "{{ compose_zitadel_db_username }}"
      POSTGRES_PASSWORD: "{{ compose_zitadel_db_password }}"
      POSTGRES_DB: "{{ compose_zitadel_db_dbname }}"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready", "-d", "{{ compose_zitadel_db_dbname }}"]
      interval: '10s'
      timeout: '30s'
      retries: 5
      start_period: '20s'
    volumes:
      - postgres-data:/var/lib/postgresql/data

volumes:
  postgres-data: {}

networks:
  traefik:
    name: traefik
